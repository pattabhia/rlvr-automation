FROM runpod/pytorch:2.1.0-py3.10-cuda12.1.0-devel-ubuntu22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    wget \
    ca-certificates \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Install Qdrant binary
RUN cd /tmp && \
    wget -q https://github.com/qdrant/qdrant/releases/download/v1.7.4/qdrant-x86_64-unknown-linux-gnu.tar.gz && \
    tar -xzf qdrant-x86_64-unknown-linux-gnu.tar.gz && \
    mv qdrant /usr/local/bin/ && \
    chmod +x /usr/local/bin/qdrant && \
    rm qdrant-x86_64-unknown-linux-gnu.tar.gz

# Install RabbitMQ
RUN apt-get update && apt-get install -y rabbitmq-server && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace/rlvr-pdf-chat

# Copy project files
COPY . /workspace/rlvr-pdf-chat/

# Install all Python dependencies from requirements files
RUN pip install --no-cache-dir --upgrade \
    -r services/qa-orchestrator/requirements.txt \
    -r services/api-gateway/requirements.txt \
    -r services/document-ingestion/requirements.txt \
    -r ui/streamlit/requirements.txt \
    -r workers/verification-worker/requirements.txt \
    -r workers/dataset-generation-worker/requirements.txt

# Create data directories
RUN mkdir -p \
    /workspace/rlvr-pdf-chat/data/training_data \
    /workspace/rlvr-pdf-chat/data/dpo_data \
    /workspace/rlvr-pdf-chat/data/uploads \
    /workspace/qdrant_storage \
    /app/data/training_data \
    /app/data/dpo_data

# Expose all required ports
EXPOSE 8501 8000 8001 8002 6333 11434 5672

# Set environment variables
ENV PYTHONPATH=/workspace/rlvr-pdf-chat
ENV RABBITMQ_URL=amqp://rlvr:rlvr_password@localhost:5672/
ENV OLLAMA_HOST=http://localhost:11434
ENV OLLAMA_URL=http://localhost:11434
ENV OLLAMA_MODEL=llama3.2:3b
ENV QDRANT_URL=http://localhost:6333
ENV QDRANT_HOST=localhost
ENV QDRANT_PORT=6333
ENV QA_ORCHESTRATOR_URL=http://localhost:8001
ENV DOC_INGESTION_SERVICE_URL=http://localhost:8002
ENV TRAINING_DATA_DIR=/workspace/rlvr-pdf-chat/data/training_data
ENV DPO_DATA_DIR=/app/data/dpo_data
ENV OLLAMA_GPU_LAYERS=999
ENV CUDA_VISIBLE_DEVICES=0

# Copy supervisor configuration
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Make startup script executable
RUN chmod +x runpod_launch_all.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:8501 && curl -f http://localhost:8000/health || exit 1

# Use supervisor to manage all services
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

